service: g2-chatbot-backend

provider:
  name: aws
  runtime: python3.11
  region: us-east-1
  stage: dev
  environment:
    BIGKINDS_API_KEY: ${env:BIGKINDS_API_KEY}
    AWS_REGION: us-east-1
  iamRoleStatements:
    - Effect: Allow
      Action:
        - logs:CreateLogGroup
        - logs:CreateLogStream
        - logs:PutLogEvents
      Resource: 
        - "arn:aws:logs:us-east-1:*:log-group:/aws/lambda/*"
    - Effect: Allow
      Action:
        - bedrock:InvokeModel
      Resource:
        - "arn:aws:bedrock:us-east-1::foundation-model/anthropic.claude-3-sonnet-20240229-v1:0"
    - Effect: Allow
      Action:
        - cloudwatch:PutMetricData
      Resource: "*"
    - Effect: Allow
      Action:
        - secretsmanager:GetSecretValue
      Resource:
        - "arn:aws:secretsmanager:us-east-1:*:secret:g2/*"

functions:
  enhanced-chatbot:
    handler: lambda/enhanced-chatbot-handler.lambda_handler
    timeout: 60
    memorySize: 1024
    description: "RAG 기반 Enhanced Claude 챗봇 - BigKinds API 통합"
    events:
      - http:
          path: /chat
          method: post
          cors:
            origin: '*'
            headers:
              - Content-Type
              - X-Amz-Date
              - Authorization
              - X-Api-Key
              - X-Amz-Security-Token
            allowCredentials: false
      - http:
          path: /chat
          method: options
          cors:
            origin: '*'
            headers:
              - Content-Type
              - X-Amz-Date
              - Authorization
              - X-Api-Key
              - X-Amz-Security-Token
            allowCredentials: false

plugins:
  - serverless-python-requirements

custom:
  pythonRequirements:
    dockerizePip: true
    layer: true
    slim: true
    strip: false
    pythonBin: python3.11
    zip: true
    useStaticCache: true
    useDownloadCache: true